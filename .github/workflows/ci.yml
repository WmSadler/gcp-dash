name: CI

on:
  push:
    branches:
      - "**"
  pull_request:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Shellcheck
        run: |
          shellcheck -S warning \
            gcp- \
            gcp-auth \
            gcp-status \
            gcp-ls \
            gcp-cp-profile \
            gcp-nc \
            gcp-rm-profile \
            gcp-common \
            deploy-bin \
            tests/test-gcp-helpers.sh

      - name: Bash Syntax
        run: |
          bash -n \
            gcp- \
            gcp-auth \
            gcp-status \
            gcp-ls \
            gcp-cp-profile \
            gcp-nc \
            gcp-rm-profile \
            gcp-common \
            deploy-bin \
            tests/test-gcp-helpers.sh

      - name: Smoke Tests
        run: |
          chmod +x tests/test-gcp-helpers.sh
          ./tests/test-gcp-helpers.sh

  sync-remotes:
    name: Sync Remotes
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to origin/main
        run: git push origin HEAD:main

      - name: Validate mirror auth configuration
        env:
          PUBLIC_MIRROR_SSH_KEY: ${{ secrets.PUBLIC_MIRROR_SSH_KEY }}
        run: |
          if [[ -z "${PUBLIC_MIRROR_SSH_KEY:-}" ]]; then
            echo "Missing required secret: PUBLIC_MIRROR_SSH_KEY"
            exit 1
          fi

      - name: Load mirror SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PUBLIC_MIRROR_SSH_KEY }}

      - name: Push to public/main
        env:
          PUBLIC_MIRROR_URL: ${{ vars.PUBLIC_MIRROR_URL }}
        run: |
          mirror_url="${PUBLIC_MIRROR_URL:-git@github.com:WmSadler/gcp-dash.git}"
          git remote add public "$mirror_url"
          git push public HEAD:main

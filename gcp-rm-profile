#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./gcp-common
source "${SCRIPT_DIR}/gcp-common"

usage() {
  cat <<USAGE
Usage:
  gcp-rm-profile [-y|--yes] [comma_separated_numbers]
  gcp-rm-profile -h|--help

Description:
  Shows saved GCP profiles in alphabetical order with numbers and deletes
  selected profiles after one confirmation prompt.

Examples:
  gcp-rm-profile
  gcp-rm-profile 1,3,5

Notes:
  - Profile base is \$GCP_CFG_BASE or ~/.config/gcloud-codex by default.
  - Deletion is recursive and permanent.
USAGE
  echo
  echo "Other GCP commands:"
  gcp_print_command_catalog "gcp-rm-profile"
}

BASE_DIR="$(gcp_base_dir)"
declare -a profiles=()
declare -A profile_accounts=()
declare -A profile_projects=()
ASSUME_YES=0

while [[ $# -gt 0 ]]; do
  case "${1:-}" in
    -h|--help)
      usage
      exit 0
      ;;
    -y|--yes)
      ASSUME_YES=1
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Error: unknown option: $1" >&2
      usage
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

gcp_collect_profiles "$BASE_DIR" profiles profile_accounts profile_projects

if [[ "${#profiles[@]}" -eq 0 ]]; then
  echo "No profiles found in: $BASE_DIR"
  exit 0
fi

echo "GCP profiles in: $BASE_DIR"
gcp_print_profiles_numbered profiles profile_accounts profile_projects
echo

SELECTION="${1:-}"
if [[ -z "$SELECTION" ]]; then
  read -r -p "Enter comma-separated profile numbers to delete (blank cancels): " SELECTION
fi

SELECTION="$(echo "$SELECTION" | tr -d '[:space:]')"
if [[ -z "$SELECTION" ]]; then
  echo "No selection made. Nothing deleted."
  exit 0
fi

IFS=',' read -r -a tokens <<< "$SELECTION"
declare -A seen=()
declare -a selected=()

for token in "${tokens[@]}"; do
  if [[ -z "$token" || ! "$token" =~ ^[0-9]+$ ]]; then
    echo "Error: invalid selection token '$token'." >&2
    exit 2
  fi

  idx="$token"
  if (( idx < 1 || idx > ${#profiles[@]} )); then
    echo "Error: selection '$idx' is out of range." >&2
    exit 2
  fi

  if [[ -z "${seen[$idx]:-}" ]]; then
    seen[$idx]=1
    selected+=("${profiles[$((idx - 1))]}")
  fi
done

echo "Profiles selected for deletion:"
for i in "${!selected[@]}"; do
  name="${selected[$i]}"
  printf "%2d) %s, %s, %s\n" "$((i + 1))" "$name" "${profile_accounts[$name]}" "${profile_projects[$name]}"
done
echo

if [[ "$ASSUME_YES" -ne 1 ]]; then
  if [[ ! -t 0 ]]; then
    echo "Error: confirmation requires an interactive terminal. Use -y|--yes for non-interactive mode." >&2
    exit 1
  fi

  read -r -p "Delete ${#selected[@]} profile(s)? [y/N]: " confirm
  if [[ ! "$confirm" =~ ^[Yy]([Ee][Ss])?$ ]]; then
    echo "Aborted. Nothing deleted."
    exit 1
  fi
fi

run_delete_profiles() {
  local name
  for name in "${selected[@]}"; do
    rm -rf -- "$BASE_DIR/$name"
    echo "Deleted: $name"
  done
}

gcp_run_with_lock "$BASE_DIR" run_delete_profiles

#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=./gcp-common
source "${SCRIPT_DIR}/gcp-common"

usage() {
  cat <<USAGE
Usage:
  gcp-cp-profile [-y|--yes] [profile_number_or_name] [new_name]
  gcp-cp-profile -h|--help

Description:
  Copies one saved GCP profile by number or name to a new profile name.

Examples:
  gcp-cp-profile
  gcp-cp-profile 2 c1-stage-copy
  gcp-cp-profile c1-stage c1-stage-copy

Notes:
  - Profile base is \$GCP_CFG_BASE or \$XDG_CONFIG_HOME/gcpdash (or ~/.config/gcpdash) by default.
  - Copies the full profile directory (config and cached credentials).
USAGE
  echo
  echo "Other GCP commands:"
  gcp_print_command_catalog "gcp-cp-profile"
}

BASE_DIR="$(gcp_base_dir)"
declare -a profiles=()
declare -A profile_accounts=()
declare -A profile_projects=()
ASSUME_YES=0

while [[ $# -gt 0 ]]; do
  case "${1:-}" in
    -h|--help)
      usage
      exit 0
      ;;
    -y|--yes)
      ASSUME_YES=1
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Error: unknown option: $1" >&2
      usage
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

gcp_collect_profiles "$BASE_DIR" profiles profile_accounts profile_projects

if [[ "${#profiles[@]}" -eq 0 ]]; then
  echo "No profiles found in: $BASE_DIR"
  exit 0
fi

echo "GCP profiles in: $BASE_DIR"
gcp_print_profiles_numbered profiles profile_accounts profile_projects
echo

PROFILE_SELECTOR="${1:-}"
NEW_NAME="${2:-}"

if [[ -z "$PROFILE_SELECTOR" ]]; then
  if [[ ! -t 0 ]]; then
    echo "Error: profile selector required in non-interactive mode." >&2
    exit 2
  fi
  read -r -p "Enter profile number or name to copy (blank cancels): " PROFILE_SELECTOR
fi

PROFILE_SELECTOR="$(echo "$PROFILE_SELECTOR" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
if [[ -z "$PROFILE_SELECTOR" ]]; then
  echo "No profile selector provided. Nothing changed."
  exit 0
fi

SRC_NAME=""
SRC_INDEX=0
if ! gcp_resolve_profile_selector profiles "$PROFILE_SELECTOR" SRC_NAME SRC_INDEX; then
  echo "Error: profile selector '$PROFILE_SELECTOR' not found." >&2
  exit 2
fi

SRC_DIR="${BASE_DIR}/${SRC_NAME}"

if [[ -z "$NEW_NAME" ]]; then
  if [[ ! -t 0 ]]; then
    echo "Error: new name required in non-interactive mode." >&2
    exit 2
  fi
  read -r -p "Enter new name for copy of '${SRC_NAME}' (blank cancels): " NEW_NAME
fi

NEW_NAME="$(echo "$NEW_NAME" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
if [[ -z "$NEW_NAME" ]]; then
  echo "No new name provided. Nothing changed."
  exit 0
fi

if ! gcp_validate_new_profile_name "$NEW_NAME"; then
  echo "Error: invalid new name '$NEW_NAME'." >&2
  exit 2
fi

if [[ "$NEW_NAME" == "$SRC_NAME" ]]; then
  echo "Error: new name must differ from source profile name." >&2
  exit 2
fi

DST_DIR="${BASE_DIR}/${NEW_NAME}"
if [[ -e "$DST_DIR" ]]; then
  echo "Error: target profile '$NEW_NAME' already exists." >&2
  exit 2
fi

if [[ ! -t 0 && "$ASSUME_YES" -ne 1 ]]; then
  echo "Error: non-interactive mutation requires -y|--yes." >&2
  exit 2
fi

run_copy_profile() {
  cp -a -- "$SRC_DIR" "$DST_DIR"
}

gcp_run_with_lock "$BASE_DIR" run_copy_profile
echo "Copied profile #$SRC_INDEX: '$SRC_NAME' -> '$NEW_NAME'"

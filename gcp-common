#!/usr/bin/env bash

GCP_COMMAND_CATALOG=(
  "gcp-|show all available gcp helper commands"
  "gcp-auth|authenticate/switch profile for current shell"
  "gcp-status|show current shell gcp context"
  "gcp-ls|list profiles"
  "gcp-cp-profile|copy a profile by number or name"
  "gcp-nc|rename a profile by number or name"
  "gcp-rm-profile|delete profiles by number"
)

gcp_lock_dir() {
  local base_dir="$1"
  printf "%s/.gcpdash.lock" "$base_dir"
}

gcp_base_dir() {
  printf "%s" "${GCP_CFG_BASE:-${XDG_CONFIG_HOME:-${HOME}/.config}/gcpdash}"
}

gcp_profile_config_file() {
  local profile_dir="$1"
  local cfg_file="${profile_dir}/configurations/config_default"
  if [[ -s "${profile_dir}/active_config" ]]; then
    cfg_file="${profile_dir}/configurations/config_$(<"${profile_dir}/active_config")"
  fi
  printf "%s" "$cfg_file"
}

gcp_profile_value() {
  local profile_dir="$1"
  local key="$2"
  local cfg_file
  local value="<unset>"

  cfg_file="$(gcp_profile_config_file "$profile_dir")"
  if [[ -f "$cfg_file" ]]; then
    value="$(sed -n "s/^${key}[[:space:]]*=[[:space:]]*//p" "$cfg_file" | head -n1)"
    [[ -z "$value" ]] && value="<unset>"
  fi

  printf "%s" "$value"
}

gcp_collect_profiles() {
  local base_dir="$1"
  local -n _profiles="$2"
  local -n _accounts="$3"
  local -n _projects="$4"
  local profile

  _profiles=()
  _accounts=()
  _projects=()

  [[ -d "$base_dir" ]] || return 0

  mapfile -t _profiles < <(
    for dir in "$base_dir"/*; do
      [[ -d "$dir" ]] && basename "$dir"
    done | LC_ALL=C sort -f
  )

  for profile in "${_profiles[@]}"; do
    local profile_dir="${base_dir}/${profile}"
    _accounts["$profile"]="$(gcp_profile_value "$profile_dir" account)"
    _projects["$profile"]="$(gcp_profile_value "$profile_dir" project)"
  done
}

gcp_print_profiles_numbered() {
  # shellcheck disable=SC2178  # nameref target is array/map selected by caller
  local -n _profiles="$1"
  # shellcheck disable=SC2178  # nameref target is array/map selected by caller
  local -n _accounts="$2"
  # shellcheck disable=SC2178  # nameref target is array/map selected by caller
  local -n _projects="$3"
  local active_profile="${4:-}"
  local i=0
  local marker=" "
  local number_width
  local profile

  # Fall back to the shell-pinned profile when active_profile isn't passed.
  if [[ -z "$active_profile" && -n "${CLOUDSDK_CONFIG:-}" ]]; then
    active_profile="$(basename "$CLOUDSDK_CONFIG")"
  fi

  number_width="${#_profiles[@]}"
  number_width="${#number_width}"

  for profile in "${_profiles[@]}"; do
    i=$((i + 1))
    if [[ -n "$active_profile" && "$profile" == "$active_profile" ]]; then
      marker="*"
    else
      marker=" "
    fi
    printf "%s%${number_width}d) %s, %s, %s\n" "$marker" "$i" "$profile" "${_accounts[$profile]}" "${_projects[$profile]}"
  done
}

gcp_validate_new_profile_name() {
  local name="$1"
  [[ -n "$name" ]] || return 1
  [[ "$name" != "." && "$name" != ".." && "$name" != *"/"* ]] || return 1
  return 0
}

gcp_resolve_profile_selector() {
  # shellcheck disable=SC2178  # nameref target is array selected by caller
  local -n _profiles="$1"
  local selector_raw="$2"
  # shellcheck disable=SC2178  # nameref output value selected by caller
  local -n _profile_out="$3"
  # shellcheck disable=SC2178  # nameref output value selected by caller
  local -n _index_out="$4"
  local selector
  local i

  selector="$(echo "$selector_raw" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
  [[ -n "$selector" ]] || return 1

  if [[ "$selector" =~ ^[0-9]+$ ]]; then
    if (( selector < 1 || selector > ${#_profiles[@]} )); then
      return 1
    fi
    _index_out="$selector"
    _profile_out="${_profiles[$((selector - 1))]}"
    return 0
  fi

  for i in "${!_profiles[@]}"; do
    if [[ "${_profiles[$i]}" == "$selector" ]]; then
      _index_out="$((i + 1))"
      _profile_out="${_profiles[$i]}"
      return 0
    fi
  done

  return 1
}

gcp_run_with_lock() {
  local base_dir="$1"
  shift

  local had_errexit=0
  [[ "$-" == *e* ]] && had_errexit=1
  set +e
  (
    set -e
    local lock_dir
    local lock_pid_file
    local worker_pid
    lock_dir="$(gcp_lock_dir "$base_dir")"
    lock_pid_file="${lock_dir}/pid"
    worker_pid="$BASHPID"

    gcp_cleanup_worker_lock() {
      local lock_owner
      lock_owner="$(cat "$lock_pid_file" 2>/dev/null || true)"
      if [[ "$lock_owner" == "$worker_pid" ]]; then
        rm -rf -- "$lock_dir"
      fi
    }

    mkdir -p "$base_dir"
    if ! mkdir "$lock_dir" 2>/dev/null; then
      local lock_owner
      local stale_lock=0
      lock_owner="$(cat "$lock_pid_file" 2>/dev/null || true)"
      if [[ -z "$lock_owner" || "$lock_owner" == "$worker_pid" || ! "$lock_owner" =~ ^[0-9]+$ ]]; then
        stale_lock=1
      elif ! kill -0 "$lock_owner" 2>/dev/null; then
        stale_lock=1
      fi
      if [[ "$stale_lock" -eq 1 ]]; then
        rm -rf -- "$lock_dir"
      fi
      if ! mkdir "$lock_dir" 2>/dev/null; then
        echo "Error: another profile operation is in progress (lock: $lock_dir)." >&2
        exit 1
      fi
    fi

    printf "%s\n" "$worker_pid" > "$lock_pid_file"
    trap 'gcp_cleanup_worker_lock' EXIT
    trap 'gcp_cleanup_worker_lock; exit 130' INT
    trap 'gcp_cleanup_worker_lock; exit 143' TERM

    "$@"
  )
  local rc=$?
  (( had_errexit )) && set -e
  return "$rc"
}

gcp_json_escape() {
  local s="$1"
  s=${s//\\/\\\\}
  s=${s//\"/\\\"}
  s=${s//$'\n'/\\n}
  s=${s//$'\r'/\\r}
  s=${s//$'\t'/\\t}
  printf "%s" "$s"
}

gcp_print_profiles_json() {
  local base_dir="$1"
  # shellcheck disable=SC2178  # nameref target is array selected by caller
  local -n _profiles="$2"
  # shellcheck disable=SC2178  # nameref target is map selected by caller
  local -n _accounts="$3"
  # shellcheck disable=SC2178  # nameref target is map selected by caller
  local -n _projects="$4"
  local active_profile="${5:-}"
  local i
  local profile

  printf '{"base_dir":"%s","profiles":[' "$(gcp_json_escape "$base_dir")"
  for i in "${!_profiles[@]}"; do
    profile="${_profiles[$i]}"
    if (( i > 0 )); then
      printf ","
    fi
    printf '{"index":%d,"name":"%s","account":"%s","project":"%s","active":%s}' \
      "$((i + 1))" \
      "$(gcp_json_escape "$profile")" \
      "$(gcp_json_escape "${_accounts[$profile]}")" \
      "$(gcp_json_escape "${_projects[$profile]}")" \
      "$( [[ -n "$active_profile" && "$profile" == "$active_profile" ]] && printf "true" || printf "false" )"
  done
  printf ']}\n'
}

gcp_print_command_catalog() {
  local current="${1:-}"
  local entry cmd desc

  for entry in "${GCP_COMMAND_CATALOG[@]}"; do
    cmd="${entry%%|*}"
    desc="${entry#*|}"
    [[ -n "$current" && "$cmd" == "$current" ]] && continue
    printf "  %-14s %s\n" "$cmd" "$desc"
  done
}
